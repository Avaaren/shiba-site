{% extends 'pictures/base.html' %}
{% load static %}

{% block title %}Get shiba image {% endblock %}

{% block content %}

<div class="container-fluid">
    <div class="wrapper">
        <div class="view-count">
            <span>Вы посмотрели {{ click_count }} шайб</span>
        </div>
        <div class="header">
            <h2>shibe-site</h2>
            <p>Любишь шайб, но в твоей галерее их слишком мало?</p>
    
            <p>Воспользуйся нашим сервисом и получи доступ к неисчерпаемому источнику милых собачек</p>
            <p>Найди свою прямо сейчас</p>
        </div>
        <div class="image-container">
            <div class="image">
                <img src="{{ image_url }}" alt="">
            </div>
        </div>
        <div class="buttons">
           <div class="button">
            <form action="." method="get">
                <button type="submit">Новая шайбочка</button>
            </form>
           </div>
            <div class="button">
                <button id='download'>Скачать</button>
            </div>
        </div>
    </div>
</div>
{% csrf_token %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<script>
    $(document).ready(function () {
        let image_url = '{{ image_url }}';
        
        let filename = '{{ filename }}';
        console.log(filename);
        let token = document.querySelector('[name=csrfmiddlewaretoken]').value;
        // function downloadImage(){
        //     window.location.href = 'download/'+filename;
        // }
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            console.log(cookieValue);
            return cookieValue;
        }

        $('#download').on('click', function () {
            console.log('sadsadasdas');
            $.post({
                url: 'download/',
                headers: {
                    'X-CSRFToken': token,
                },
                data: {
                    'filename': filename,
                    'image_url': image_url,
                    // csrfmiddlewaretoken: getCookie('csrftoken')
                },
                dataType: 'json',
                success: function (response) {
                    let url = 'download/'+response.filename.split('.')[0];
                    window.location.href = url;
                }
            });
        });
    });
</script>
{% endblock %}